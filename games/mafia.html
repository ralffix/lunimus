<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Party Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 700px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            color: #e94560;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #aaa;
            font-size: 0.9em;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e94560 0%, #d63447 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #e94560;
        }

        select option {
            background: #1a1a2e;
            color: white;
        }
        
        .room-code {
            background: rgba(233, 69, 96, 0.2);
            border: 2px solid #e94560;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .room-code h2 {
            font-size: 2em;
            letter-spacing: 5px;
            color: #e94560;
        }
        
        .player-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .role-card {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border: 3px solid #e94560;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        
        .role-card h2 {
            font-size: 2em;
            margin-bottom: 15px;
            color: #e94560;
        }
        
        .role-card p {
            line-height: 1.6;
            color: #ddd;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .badge-host {
            background: #e94560;
        }
        
        .badge-alive {
            background: #4caf50;
        }
        
        .badge-dead {
            background: #666;
        }
        
        .info-box {
            background: rgba(233, 69, 96, 0.2);
            border-left: 4px solid #e94560;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .voting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .vote-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .vote-btn:hover {
            background: rgba(233, 69, 96, 0.3);
            border-color: #e94560;
        }
        
        .vote-btn.selected {
            background: #e94560;
            border-color: #e94560;
        }
        
        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .connection-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .status-connecting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .status-connected {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .status-error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .game-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid #e94560;
            background: rgba(255, 255, 255, 0.05);
        }

        .peer-id-display {
            font-size: 0.75em;
            color: #888;
            margin-top: 10px;
            word-break: break-all;
        }

        .role-config {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .role-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .role-option label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-container {
            margin: 20px 0;
        }

        .chat-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input-container input {
            margin: 0;
            flex: 1;
        }

        .chat-input-container button {
            width: auto;
            padding: 10px 20px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎭 Mafia</h1>
        <p class="subtitle">Online & Local Party Game</p>
        
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <div id="connectionStatus" class="connection-status status-connecting">
                Connecting...
            </div>
            <button class="btn btn-primary" onclick="showHostScreen()" id="hostBtn" disabled>Host Online Game</button>
            <button class="btn btn-secondary" onclick="showJoinScreen()" id="joinBtn" disabled>Join Online Game</button>
            <button class="btn btn-secondary" onclick="startLocalGame()">Local Game (One Device)</button>
            <div class="info-box" style="margin-top: 30px;">
                <strong>How to Play:</strong>
                <p style="margin-top: 10px; line-height: 1.6;">
                    Online: Host creates room and shares info. Local: Pass device around. Find the Mafia!
                </p>
            </div>
        </div>
        
        <!-- Host Setup Screen -->
        <div id="hostScreen" class="screen">
            <h2 style="margin-bottom: 20px;">Host a Game</h2>
            <input type="text" id="hostName" placeholder="Your Name" maxlength="20">
            <button class="btn btn-primary" onclick="createRoom()">Create Room</button>
            <button class="btn btn-secondary" onclick="showHome()">Back</button>
        </div>
        
        <!-- Join Screen -->
        <div id="joinScreen" class="screen">
            <h2 style="margin-bottom: 20px;">Join a Game</h2>
            <input type="text" id="playerName" placeholder="Your Name" maxlength="20">
            <input type="text" id="roomCodeInput" placeholder="Room Code (6 characters)" maxlength="6" style="text-transform: uppercase;">
            <input type="text" id="hostPeerIdInput" placeholder="Host Peer ID">
            <button class="btn btn-primary" onclick="joinRoom()">Join Room</button>
            <button class="btn btn-secondary" onclick="showHome()">Back</button>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <div class="room-code">
                <p style="margin-bottom: 5px; color: #ddd;">Room Code</p>
                <h2 id="displayRoomCode">XXXX</h2>
                <div class="peer-id-display">
                    <strong>Peer ID:</strong><br>
                    <span id="displayPeerId"></span>
                </div>
                <button class="btn btn-secondary btn-small" onclick="copyConnectionInfo()" style="margin-top: 10px;">
                    📋 Copy Info
                </button>
            </div>
            
            <h3 style="margin: 20px 0 10px 0;">Players (<span id="playerCount">0</span>)</h3>
            <div class="player-list" id="playerList"></div>
            
            <div id="hostControls" style="display: none;">
                <h3 style="margin: 20px 0 10px 0;">Game Settings</h3>
                <div class="role-config">
                    <div class="role-option">
                        <label>
                            <input type="checkbox" id="enableInspector">
                            <span>Inspector (min 7 players)</span>
                        </label>
                    </div>
                    <div class="role-option">
                        <label>
                            <input type="checkbox" id="enableGuardian">
                            <span>Guardian Angel (min 13 players)</span>
                        </label>
                    </div>
                </div>
                <div class="info-box">
                    Need at least 5 players to start
                </div>
                <button class="btn btn-primary" onclick="startGame()" id="startGameBtn">Start Game</button>
            </div>
            
            <button class="btn btn-secondary" onclick="leaveRoom()">Leave Room</button>
        </div>

        <!-- Profession Selection Screen -->
        <div id="professionScreen" class="screen">
            <div class="role-card">
                <h2>Choose Your Profession</h2>
                <p style="margin: 15px 0;">Choose a profession to introduce yourself to other players</p>
                <div class="profession-input">
                    <input type="text" id="professionInput" placeholder="e.g., Doctor, Teacher, Chef..." maxlength="30">
                </div>
                <button class="btn btn-primary" onclick="submitProfession()">Continue</button>
            </div>
        </div>
        
        <!-- Role Reveal Screen -->
        <div id="roleScreen" class="screen">
            <div class="role-card">
                <h2 id="roleName">Your Role</h2>
                <p id="roleDescription"></p>
                <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;" id="roleExtra"></p>
            </div>
            <button class="btn btn-primary" onclick="acknowledgeRole()">I Understand</button>
        </div>

        <!-- First Night Screen -->
        <div id="firstNightScreen" class="screen">
            <div class="role-card" style="background: #000;">
                <h2>🌙 First Night</h2>
                <p style="margin: 15px 0;">Close your eyes and wait...</p>
                <p id="firstNightInfo" style="font-size: 0.9em; color: #aaa;"></p>
            </div>
        </div>

        <!-- Introduction Round -->
        <div id="introductionScreen" class="screen">
            <div class="info-box">
                <h3>Introduction Round</h3>
                <p style="margin-top: 10px;">Each player introduces themselves with their profession</p>
            </div>
            <div class="player-list" id="introList"></div>
            <button class="btn btn-primary" onclick="startDayPhase()">Start Discussion</button>
        </div>
        
        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <div class="info-box">
                <strong>Phase: <span id="currentPhase">Day</span></strong>
                <p style="margin-top: 5px;">Your Role: <span id="yourRole">Villager</span></p>
                <p style="margin-top: 5px;" id="phaseInfo"></p>
            </div>
            
            <h3 style="margin: 20px 0 10px 0;">Players</h3>
            <div class="player-list" id="gamePlayerList"></div>
            
            <div id="votingSection" style="display: none;">
                <h3 style="margin: 20px 0 10px 0;"><span id="voteTitle">Vote to Eliminate</span></h3>
                <div class="voting-grid" id="votingGrid"></div>
                <button class="btn btn-primary" onclick="submitVote()" id="voteBtn">Submit Vote</button>
            </div>

            <div id="waitingSection" style="display: none;">
                <div class="info-box" style="text-align: center;">
                    <p>⏳ Waiting for other players...</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">Progress: <span id="voteProgress">0/0</span></p>
                </div>
            </div>

            <div id="chatSection" class="chat-container" style="display: none;">
                <h3 style="margin-bottom: 10px;">Chat</h3>
                <div class="chat-log" id="chatLog"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Type message...">
                    <button class="btn btn-primary" onclick="sendChat()">Send</button>
                </div>
            </div>
            
            <div class="game-log" id="gameLog"></div>
            
            <div id="hostGameControls" style="display: none; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="endGame()">End Game</button>
            </div>
        </div>

        <!-- End Game Screen -->
        <div id="endGameScreen" class="screen">
            <div class="role-card">
                <h2 id="endGameTitle">Game Over!</h2>
                <p id="endGameMessage" style="font-size: 1.5em; margin: 20px 0;"></p>
                <div id="finalRoles"></div>
            </div>
            <button class="btn btn-primary" onclick="playAgain()">Play Again</button>
            <button class="btn btn-secondary" onclick="showHome()">Leave Game</button>
        </div>

        <!-- Local Game Setup -->
        <div id="localSetupScreen" class="screen">
            <h2 style="margin-bottom: 20px;">Local Game Setup</h2>
            <div class="info-box">
                <p>Pass device around. Each player enters their name.</p>
            </div>
            <input type="text" id="localPlayerName" placeholder="Player Name" maxlength="20">
            <button class="btn btn-primary" onclick="addLocalPlayer()">Add Player</button>
            
            <h3 style="margin: 20px 0 10px 0;">Players (<span id="localPlayerCount">0</span>)</h3>
            <div class="player-list" id="localPlayerList"></div>

            <div id="localRoleConfig" style="display: none;">
                <h3 style="margin: 20px 0 10px 0;">Game Settings</h3>
                <div class="role-config">
                    <div class="role-option">
                        <label>
                            <input type="checkbox" id="localEnableInspector">
                            <span>Inspector (min 7 players)</span>
                        </label>
                    </div>
                    <div class="role-option">
                        <label>
                            <input type="checkbox" id="localEnableGuardian">
                            <span>Guardian Angel (min 13 players)</span>
                        </label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="startLocalGameRoles()" id="localStartBtn">Start Game</button>
            </div>

            <button class="btn btn-secondary" onclick="showHome()">Back</button>
        </div>

        <!-- Privacy Screen -->
        <div id="privacyScreen" class="screen">
            <div class="role-card" style="background: #000;">
                <h2 style="font-size: 3em;">👀</h2>
                <p style="font-size: 1.5em; margin: 20px 0;">Privacy Screen</p>
                <p id="privacyMessage">Pass to next player...</p>
                <button class="btn btn-primary" onclick="continueFromPrivacy()" style="margin-top: 30px;">I'm Ready</button>
            </div>
        </div>

        <!-- Local Role Screen -->
        <div id="localRoleScreen" class="screen">
            <div class="role-card">
                <p style="margin-bottom: 10px; color: #aaa;">Player: <span id="localCurrentPlayer"></span></p>
                <h2 id="localRoleName">Your Role</h2>
                <p id="localRoleDescription"></p>
                <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;" id="localRoleExtra"></p>
            </div>
            <button class="btn btn-primary" onclick="acknowledgeLocalRole()">I Understand</button>
        </div>

        <!-- Local Profession Screen -->
        <div id="localProfessionScreen" class="screen">
            <div class="role-card">
                <p style="margin-bottom: 10px; color: #aaa;">Player: <span id="localProfessionPlayer"></span></p>
                <h2>Choose Your Profession</h2>
                <p style="margin: 15px 0;">Choose a profession to introduce yourself</p>
                <div class="profession-input">
                    <input type="text" id="localProfessionInput" placeholder="e.g., Doctor, Teacher, Chef..." maxlength="30">
                </div>
                <button class="btn btn-primary" onclick="submitLocalProfession()">Continue</button>
            </div>
        </div>

        <!-- Local Game Play Screen -->
        <div id="localGameScreen" class="screen">
            <div class="info-box">
                <strong>Phase: <span id="localCurrentPhase">Day</span></strong>
                <p style="margin-top: 5px;" id="localPhaseInfo"></p>
            </div>
            
            <h3 style="margin: 20px 0 10px 0;">Players</h3>
            <div class="player-list" id="localGamePlayerList"></div>
            
            <div id="localVotingSection" style="display: none;">
                <h3 style="margin: 20px 0 10px 0;"><span id="localVoteTitle">Vote to Eliminate</span></h3>
                <p style="margin-bottom: 10px; color: #aaa;">Current Player: <span id="localVotingPlayer"></span></p>
                <div class="voting-grid" id="localVotingGrid"></div>
                <button class="btn btn-primary" onclick="submitLocalVote()" id="localVoteBtn">Submit Vote</button>
            </div>
            
            <div class="game-log" id="localGameLog"></div>
        </div>
    </div>

    <script>
        let peer = null;
        let connections = {};
        
        let gameState = {
            roomCode: '',
            playerName: '',
            peerId: '',
            isHost: false,
            hostPeerId: '',
            players: {},
            myRole: '',
            myProfession: '',
            phase: 'lobby',
            votes: {},
            hasVoted: false,
            gameStarted: false,
            nightActions: {},
            isLocalGame: false,
            localPlayers: [],
            localCurrentPlayerIndex: 0,
            localVotes: {},
            localNightActions: {}
        };

        // Initialize PeerJS
        function initPeer() {
            peer = new Peer({
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                gameState.peerId = id;
                updateConnectionStatus('Ready!', 'connected');
                document.getElementById('hostBtn').disabled = false;
                document.getElementById('joinBtn').disabled = false;
            });

            peer.on('connection', (conn) => {
                handleConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                updateConnectionStatus('Connection error', 'error');
            });
        }

        function updateConnectionStatus(message, status) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `connection-status status-${status}`;
            }
        }

        function handleConnection(conn) {
            conn.on('open', () => {
                connections[conn.peer] = conn;
                
                conn.on('data', (data) => {
                    handleMessage(data, conn);
                });

                conn.on('close', () => {
                    handlePlayerDisconnect(conn.peer);
                });
            });
        }

        function handleMessage(data, conn) {
            switch(data.type) {
                case 'join_request':
                    handleJoinRequest(data, conn);
                    break;
                case 'player_joined':
                    handlePlayerJoined(data);
                    break;
                case 'player_list':
                    handlePlayerList(data);
                    break;
                case 'game_start':
                    handleGameStart(data);
                    break;
                case 'profession_submitted':
                    handleProfessionSubmitted(data);
                    break;
                case 'start_introductions':
                    handleStartIntroductions(data);
                    break;
                case 'start_day':
                    handleStartDay();
                    break;
                case 'vote':
                    handleVote(data);
                    break;
                case 'night_action':
                    handleNightAction(data);
                    break;
                case 'phase_change':
                    handlePhaseChange(data);
                    break;
                case 'game_end':
                    handleGameEnd(data);
                    break;
                case 'player_left':
                    handlePlayerLeft(data);
                    break;
                case 'vote_progress':
                    updateVoteProgress(data);
                    break;
                case 'chat_message':
                    handleChatMessage(data);
                    break;
                case 'return_to_lobby':
                    handleReturnToLobby();
                    break;
            }
        }

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.add('active');
        }

        function showHome() {
            Object.values(connections).forEach(conn => {
                try { conn.close(); } catch (e) {}
            });
            
            const oldPeerId = gameState.peerId;
            
            connections = {};
            gameState = {
                roomCode: '',
                playerName: '',
                peerId: oldPeerId,
                isHost: false,
                hostPeerId: '',
                players: {},
                myRole: '',
                myProfession: '',
                phase: 'lobby',
                votes: {},
                hasVoted: false,
                gameStarted: false,
                nightActions: {},
                isLocalGame: false,
                localPlayers: [],
                localCurrentPlayerIndex: 0,
                localVotes: {},
                localNightActions: {}
            };
            
            showScreen('homeScreen');
        }

        function showHostScreen() {
            showScreen('hostScreen');
        }

        function showJoinScreen() {
            showScreen('joinScreen');
        }

        // Room management
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function createRoom() {
            const hostName = document.getElementById('hostName').value.trim();
            if (!hostName) {
                alert('Please enter your name!');
                return;
            }

            gameState.roomCode = generateRoomCode();
            gameState.playerName = hostName;
            gameState.isHost = true;
            gameState.hostPeerId = gameState.peerId;
            
            gameState.players[gameState.peerId] = {
                name: hostName,
                peerId: gameState.peerId,
                isHost: true,
                role: null,
                profession: null,
                alive: true,
                connected: true
            };

            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            document.getElementById('displayPeerId').textContent = gameState.peerId;
            updatePlayerList();
            showScreen('lobbyScreen');
            document.getElementById('hostControls').style.display = 'block';
            addLog(`Room created: ${gameState.roomCode}`);
        }

        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            const hostPeerId = document.getElementById('hostPeerIdInput').value.trim();
            
            if (!playerName || !roomCode || !hostPeerId) {
                alert('Please fill all fields!');
                return;
            }

            gameState.roomCode = roomCode;
            gameState.playerName = playerName;
            gameState.hostPeerId = hostPeerId;
            
            updateConnectionStatus('Connecting...', 'connecting');

            const conn = peer.connect(hostPeerId, { reliable: true });
            
            conn.on('open', () => {
                connections[hostPeerId] = conn;
                updateConnectionStatus('Connected!', 'connected');
                
                conn.send({
                    type: 'join_request',
                    playerName: playerName,
                    peerId: gameState.peerId,
                    roomCode: roomCode
                });

                conn.on('data', (data) => {
                    handleMessage(data, conn);
                });

                conn.on('close', () => {
                    alert('Connection lost!');
                    showHome();
                });
            });

            conn.on('error', (err) => {
                updateConnectionStatus('Connection failed!', 'error');
                alert('Could not connect! Check Peer ID.');
            });
        }

        function handleJoinRequest(data, conn) {
            if (!gameState.isHost) return;

            if (gameState.gameStarted) {
                conn.send({ type: 'error', message: 'Game already started!' });
                return;
            }

            gameState.players[data.peerId] = {
                name: data.playerName,
                peerId: data.peerId,
                isHost: false,
                role: null,
                profession: null,
                alive: true,
                connected: true
            };

            conn.send({
                type: 'player_list',
                players: gameState.players,
                hostPeerId: gameState.hostPeerId,
                roomCode: gameState.roomCode
            });

            broadcast({
                type: 'player_joined',
                player: gameState.players[data.peerId]
            }, data.peerId);

            updatePlayerList();
            addLog(`${data.playerName} joined!`);
        }

        function handlePlayerJoined(data) {
            gameState.players[data.player.peerId] = data.player;
            updatePlayerList();
            addLog(`${data.player.name} joined!`);
        }

        function handlePlayerList(data) {
            gameState.players = data.players;
            gameState.hostPeerId = data.hostPeerId;
            gameState.roomCode = data.roomCode;
            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            updatePlayerList();
            showScreen('lobbyScreen');
            addLog('Joined room!');
        }

        function updatePlayerList() {
            const list = document.getElementById('playerList');
            const count = document.getElementById('playerCount');
            
            const playerArray = Object.values(gameState.players);
            list.innerHTML = '';
            count.textContent = playerArray.length;
            
            playerArray.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${player.name}</span>
                    ${player.isHost ? '<span class="status-badge badge-host">HOST</span>' : ''}
                `;
                list.appendChild(div);
            });

            if (gameState.isHost) {
                const startBtn = document.getElementById('startGameBtn');
                if (startBtn) {
                    startBtn.disabled = playerArray.length < 5;
                }
                
                const inspectorCheckbox = document.getElementById('enableInspector');
                const guardianCheckbox = document.getElementById('enableGuardian');
                
                if (inspectorCheckbox) {
                    inspectorCheckbox.disabled = playerArray.length < 7;
                    if (playerArray.length < 7) inspectorCheckbox.checked = false;
                }
                
                if (guardianCheckbox) {
                    guardianCheckbox.disabled = playerArray.length < 13;
                    if (playerArray.length < 13) guardianCheckbox.checked = false;
                }
            }
        }

        function leaveRoom() {
            if (confirm('Leave game?')) {
                if (gameState.isHost) {
                    broadcast({ type: 'game_end', message: 'Host ended game', winner: null });
                }
                showHome();
            }
        }

        function copyConnectionInfo() {
            const code = document.getElementById('displayRoomCode').textContent;
            const peerId = document.getElementById('displayPeerId').textContent;
            const info = `Mafia Game\nRoom: ${code}\nPeer ID: ${peerId}`;
            
            navigator.clipboard.writeText(info).then(() => {
                alert('Copied!');
            }).catch(() => {
                alert(info);
            });
        }

        // Game start
        function startGame() {
            if (!gameState.isHost) return;
            
            const playerArray = Object.values(gameState.players);
            if (playerArray.length < 5) {
                alert('Need at least 5 players!');
                return;
            }

            gameState.gameStarted = true;
            const playerCount = playerArray.length;
            
            let mafiaCount;
            if (playerCount <= 10) mafiaCount = 2;
            else if (playerCount <= 15) mafiaCount = 3;
            else mafiaCount = 4;
            
            const roles = [];
            for (let i = 0; i < mafiaCount; i++) roles.push('Mafia');
            
            const enableInspector = document.getElementById('enableInspector').checked;
            const enableGuardian = document.getElementById('enableGuardian').checked;
            
            if (enableInspector && playerCount >= 7) roles.push('Inspector');
            if (enableGuardian && playerCount >= 13) roles.push('Guardian');
            
            while (roles.length < playerCount) roles.push('Villager');
            
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }
            
            playerArray.forEach((player, i) => {
                player.role = roles[i];
                gameState.players[player.peerId].role = roles[i];
            });

            broadcast({
                type: 'game_start',
                players: gameState.players
            });

            const myPlayer = gameState.players[gameState.peerId];
            gameState.myRole = myPlayer.role;
            showRoleScreen(myPlayer.role);
        }

        function handleGameStart(data) {
            gameState.players = data.players;
            gameState.gameStarted = true;
            
            const myPlayer = gameState.players[gameState.peerId];
            gameState.myRole = myPlayer.role;
            showRoleScreen(myPlayer.role);
        }

        function showRoleScreen(role) {
            const roleName = document.getElementById('roleName');
            const roleDesc = document.getElementById('roleDescription');
            const roleExtra = document.getElementById('roleExtra');
            
            if (role === 'Mafia') {
                roleName.textContent = 'MAFIA';
                roleDesc.textContent = 'Eliminate villagers at night. Blend in during the day.';
                
                const mafiaMembers = Object.values(gameState.players)
                    .filter(p => p.role === 'Mafia' && p.peerId !== gameState.peerId)
                    .map(p => p.name);
                
                roleExtra.textContent = mafiaMembers.length > 0 
                    ? `Partners: ${mafiaMembers.join(', ')}` 
                    : 'You are alone';
            } else if (role === 'Inspector') {
                roleName.textContent = 'INSPECTOR';
                roleDesc.textContent = 'Each night, choose one player to investigate. If they are Mafia, they are eliminated!';
                roleExtra.textContent = 'Use your power wisely';
            } else if (role === 'Guardian') {
                roleName.textContent = 'GUARDIAN ANGEL';
                roleDesc.textContent = 'Each night, protect one player from Mafia. You know who the Mafia are but cannot speak during day discussions.';
                const mafiaMembers = Object.values(gameState.players)
                    .filter(p => p.role === 'Mafia')
                    .map(p => p.name);
                roleExtra.textContent = `Mafia: ${mafiaMembers.join(', ')}`;
            } else {
                roleName.textContent = 'VILLAGER';
                roleDesc.textContent = 'Find and eliminate the Mafia through discussion and voting!';
                roleExtra.textContent = 'Trust no one';
            }
            
            showScreen('roleScreen');
        }

        function acknowledgeRole() {
            showScreen('professionScreen');
        }

        function submitProfession() {
            const profession = document.getElementById('professionInput').value.trim();
            if (!profession) {
                alert('Please enter a profession!');
                return;
            }
            
            gameState.myProfession = profession;
            gameState.players[gameState.peerId].profession = profession;
            
            if (gameState.isHost) {
                broadcast({
                    type: 'profession_submitted',
                    peerId: gameState.peerId,
                    profession: profession
                });
                checkAllProfessionsSubmitted();
            } else {
                connections[gameState.hostPeerId].send({
                    type: 'profession_submitted',
                    peerId: gameState.peerId,
                    profession: profession
                });
            }
            
            showScreen('firstNightScreen');
            document.getElementById('firstNightInfo').textContent = 'Waiting for all players...';
        }

        function handleProfessionSubmitted(data) {
            gameState.players[data.peerId].profession = data.profession;
            
            if (gameState.isHost) {
                broadcast({
                    type: 'profession_submitted',
                    peerId: data.peerId,
                    profession: data.profession
                }, data.peerId);
                checkAllProfessionsSubmitted();
            }
        }

        function checkAllProfessionsSubmitted() {
            if (!gameState.isHost) return;
            
            const allSubmitted = Object.values(gameState.players)
                .every(p => p.profession);
            
            if (allSubmitted) {
                setTimeout(() => {
                    broadcast({
                        type: 'start_introductions',
                        players: gameState.players
                    });
                    handleStartIntroductions({ players: gameState.players });
                }, 2000);
            }
        }

        function handleStartIntroductions(data) {
            gameState.players = data.players;
            
            const introList = document.getElementById('introList');
            introList.innerHTML = '';
            
            Object.values(gameState.players).forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span><strong>${player.name}</strong></span>
                    <span>${player.profession}</span>
                `;
                introList.appendChild(div);
            });
            
            showScreen('introductionScreen');
        }

        function startDayPhase() {
            if (gameState.isLocalGame) {
                gameState.phase = 'day';
                gameState.localCurrentPlayerIndex = 0;
                gameState.localVotes = {};
                startLocalDayPhase();
            } else {
                if (gameState.isHost) {
                    broadcast({ type: 'start_day' });
                }
                handleStartDay();
            }
        }

        function handleStartDay() {
            gameState.phase = 'day';
            showGameScreen();
        }

        function showGameScreen() {
            document.getElementById('yourRole').textContent = gameState.myRole;
            document.getElementById('chatSection').style.display = 'block';
            updateGameScreen();
            
            if (gameState.isHost) {
                document.getElementById('hostGameControls').style.display = 'block';
            }
            
            showScreen('gameScreen');
        }

        function updateGameScreen() {
            const phaseEl = document.getElementById('currentPhase');
            const phaseInfo = document.getElementById('phaseInfo');
            
            if (gameState.phase === 'day') {
                phaseEl.textContent = 'Day - Discussion & Voting';
                phaseInfo.textContent = 'Vote to eliminate a suspected Mafia';
                
                if (gameState.myRole !== 'Guardian' && !gameState.hasVoted) {
                    showVoting();
                } else if (gameState.myRole === 'Guardian') {
                    phaseInfo.textContent = 'You cannot participate in voting (Guardian)';
                    document.getElementById('votingSection').style.display = 'none';
                    document.getElementById('waitingSection').style.display = 'block';
                }
            } else if (gameState.phase === 'night') {
                phaseEl.textContent = 'Night';
                
                if (gameState.myRole === 'Mafia') {
                    phaseInfo.textContent = 'Choose target to eliminate';
                    if (!gameState.hasVoted) showVoting();
                } else if (gameState.myRole === 'Inspector') {
                    phaseInfo.textContent = 'Choose player to investigate';
                    if (!gameState.hasVoted) showVoting();
                } else if (gameState.myRole === 'Guardian') {
                    phaseInfo.textContent = 'Choose player to protect';
                    if (!gameState.hasVoted) showVoting();
                } else {
                    phaseInfo.textContent = 'Night time... wait for morning';
                    document.getElementById('votingSection').style.display = 'none';
                    document.getElementById('waitingSection').style.display = 'block';
                }
            }
            
            updateGamePlayerList();
        }

        function updateGamePlayerList() {
            const list = document.getElementById('gamePlayerList');
            list.innerHTML = '';
            
            Object.values(gameState.players).forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${player.name} (${player.profession})</span>
                    <span class="status-badge ${player.alive ? 'badge-alive' : 'badge-dead'}">
                        ${player.alive ? 'ALIVE' : 'DEAD'}
                    </span>
                `;
                list.appendChild(div);
            });
        }

        function showVoting() {
            document.getElementById('votingSection').style.display = 'block';
            document.getElementById('waitingSection').style.display = 'none';
            
            const grid = document.getElementById('votingGrid');
            const voteTitle = document.getElementById('voteTitle');
            grid.innerHTML = '';
            
            if (gameState.phase === 'night') {
                if (gameState.myRole === 'Mafia') {
                    voteTitle.textContent = 'Choose Target';
                } else if (gameState.myRole === 'Inspector') {
                    voteTitle.textContent = 'Investigate Player';
                } else if (gameState.myRole === 'Guardian') {
                    voteTitle.textContent = 'Protect Player';
                }
            } else {
                voteTitle.textContent = 'Vote to Eliminate';
            }
            
            Object.values(gameState.players)
                .filter(p => p.alive && p.peerId !== gameState.peerId)
                .forEach(player => {
                    const btn = document.createElement('button');
                    btn.className = 'vote-btn';
                    btn.textContent = player.name;
                    btn.onclick = () => selectVote(player.peerId, btn);
                    grid.appendChild(btn);
                });
        }

        let selectedVote = null;
        function selectVote(peerId, btn) {
            document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedVote = peerId;
        }

        function submitVote() {
            if (!selectedVote) {
                alert('Please select someone!');
                return;
            }
            
            gameState.hasVoted = true;
            
            const voteData = {
                type: gameState.phase === 'night' ? 'night_action' : 'vote',
                voterPeerId: gameState.peerId,
                targetPeerId: selectedVote,
                phase: gameState.phase,
                action: gameState.myRole
            };
            
            if (gameState.isHost) {
                if (gameState.phase === 'night') {
                    handleNightAction(voteData);
                } else {
                    handleVote(voteData);
                }
            } else {
                connections[gameState.hostPeerId].send(voteData);
            }
            
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('waitingSection').style.display = 'block';
            addLog('Vote submitted!');
            
            selectedVote = null;
        }

        function handleVote(data) {
            if (!gameState.isHost) return;
            
            gameState.votes[data.voterPeerId] = data.targetPeerId;
            
            const alivePlayers = Object.values(gameState.players).filter(p => p.alive);
            const guardianAlive = alivePlayers.some(p => p.role === 'Guardian');
            const votesNeeded = guardianAlive ? alivePlayers.length - 1 : alivePlayers.length;
            
            const votesReceived = Object.keys(gameState.votes).length;
            
            broadcast({
                type: 'vote_progress',
                votes: votesReceived,
                needed: votesNeeded
            });
            
            if (votesReceived >= votesNeeded) {
                processVotes();
            }
        }

        function handleNightAction(data) {
            if (!gameState.isHost) return;
            
            gameState.nightActions[data.voterPeerId] = {
                target: data.targetPeerId,
                action: data.action
            };
            
            const mafiaCount = Object.values(gameState.players).filter(p => p.alive && p.role === 'Mafia').length;
            const inspectorAlive = Object.values(gameState.players).some(p => p.alive && p.role === 'Inspector');
            const guardianAlive = Object.values(gameState.players).some(p => p.alive && p.role === 'Guardian');
            
            let actionsNeeded = mafiaCount;
            if (inspectorAlive) actionsNeeded++;
            if (guardianAlive) actionsNeeded++;
            
            const actionsReceived = Object.keys(gameState.nightActions).length;
            
            broadcast({
                type: 'vote_progress',
                votes: actionsReceived,
                needed: actionsNeeded
            });
            
            if (actionsReceived >= actionsNeeded) {
                processNightActions();
            }
        }

        function processVotes() {
            const voteCounts = {};
            Object.values(gameState.votes).forEach(targetId => {
                voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            });
            
            let maxVotes = 0;
            let eliminatedId = null;
            
            Object.entries(voteCounts).forEach(([peerId, count]) => {
                if (count > maxVotes) {
                    maxVotes = count;
                    eliminatedId = peerId;
                }
            });
            
            if (eliminatedId) {
                gameState.players[eliminatedId].alive = false;
                const eliminatedPlayer = gameState.players[eliminatedId];
                
                const aliveMafia = Object.values(gameState.players).filter(p => p.alive && p.role === 'Mafia').length;
                const aliveVillagers = Object.values(gameState.players).filter(p => p.alive && p.role !== 'Mafia').length;
                
                if (aliveMafia === 0) {
                    broadcast({
                        type: 'game_end',
                        winner: 'Villagers',
                        message: 'Villagers Win!',
                        eliminated: [{name: eliminatedPlayer.name, reason: 'Voted'}],
                        players: gameState.players
                    });
                    handleGameEnd({winner: 'Villagers', message: 'Villagers Win!', eliminated: [{name: eliminatedPlayer.name}], players: gameState.players});
                    return;
                } else if (aliveMafia >= aliveVillagers) {
                    broadcast({
                        type: 'game_end',
                        winner: 'Mafia',
                        message: 'Mafia Wins!',
                        eliminated: [{name: eliminatedPlayer.name, reason: 'Voted'}],
                        players: gameState.players
                    });
                    handleGameEnd({winner: 'Mafia', message: 'Mafia Wins!', eliminated: [{name: eliminatedPlayer.name}], players: gameState.players});
                    return;
                }
                
                gameState.votes = {};
                gameState.nightActions = {};
                gameState.phase = 'night';
                gameState.hasVoted = false;
                
                broadcast({
                    type: 'phase_change',
                    phase: 'night',
                    players: gameState.players,
                    eliminated: [{name: eliminatedPlayer.name, role: eliminatedPlayer.role, reason: 'Voted'}]
                });
                
                handlePhaseChange({
                    phase: 'night', 
                    players: gameState.players, 
                    eliminated: [{name: eliminatedPlayer.name, role: eliminatedPlayer.role, reason: 'Voted'}]
                });
            }
        }

        function processNightActions() {
            const mafiaActions = Object.values(gameState.nightActions).filter(a => a.action === 'Mafia');
            const mafiaVotes = {};
            mafiaActions.forEach(a => {
                mafiaVotes[a.target] = (mafiaVotes[a.target] || 0) + 1;
            });
            
            let mafiaTarget = null;
            let maxVotes = 0;
            Object.entries(mafiaVotes).forEach(([peerId, count]) => {
                if (count > maxVotes) {
                    maxVotes = count;
                    mafiaTarget = peerId;
                }
            });
            
            const inspectorAction = Object.values(gameState.nightActions).find(a => a.action === 'Inspector');
            let inspectorResult = null;
            if (inspectorAction) {
                const target = gameState.players[inspectorAction.target];
                if (target && target.role === 'Mafia') {
                    inspectorResult = inspectorAction.target;
                }
            }
            
            const guardianAction = Object.values(gameState.nightActions).find(a => a.action === 'Guardian');
            const protected = guardianAction ? guardianAction.target : null;
            
            let eliminated = [];
            
            if (inspectorResult) {
                gameState.players[inspectorResult].alive = false;
                eliminated.push({
                    peerId: inspectorResult,
                    name: gameState.players[inspectorResult].name,
                    reason: 'Inspector'
                });
            }
            
            if (mafiaTarget && mafiaTarget !== protected) {
                gameState.players[mafiaTarget].alive = false;
                eliminated.push({
                    peerId: mafiaTarget,
                    name: gameState.players[mafiaTarget].name,
                    reason: 'Mafia'
                });
            } else if (mafiaTarget === protected) {
                eliminated.push({
                    peerId: null,
                    name: 'No one',
                    reason: 'Protected'
                });
            }
            
            const aliveMafia = Object.values(gameState.players).filter(p => p.alive && p.role === 'Mafia').length;
            const aliveVillagers = Object.values(gameState.players).filter(p => p.alive && p.role !== 'Mafia').length;
            
            if (aliveMafia === 0) {
                broadcast({
                    type: 'game_end',
                    winner: 'Villagers',
                    message: 'Villagers Win!',
                    eliminated: eliminated,
                    players: gameState.players
                });
                handleGameEnd({winner: 'Villagers', message: 'Villagers Win!', eliminated, players: gameState.players});
                return;
            } else if (aliveMafia >= aliveVillagers) {
                broadcast({
                    type: 'game_end',
                    winner: 'Mafia',
                    message: 'Mafia Wins!',
                    eliminated: eliminated,
                    players: gameState.players
                });
                handleGameEnd({winner: 'Mafia', message: 'Mafia Wins!', eliminated, players: gameState.players});
                return;
            }
            
            gameState.nightActions = {};
            gameState.votes = {};
            gameState.phase = 'day';
            gameState.hasVoted = false;
            
            broadcast({
                type: 'phase_change',
                phase: 'day',
                players: gameState.players,
                eliminated: eliminated
            });
            
            handlePhaseChange({phase: 'day', players: gameState.players, eliminated});
        }

        function handlePhaseChange(data) {
            gameState.players = data.players;
            gameState.phase = data.phase;
            gameState.hasVoted = false;
            
            data.eliminated.forEach(e => {
                if (e.name !== 'No one') {
                    const reason = e.reason === 'Inspector' ? 'caught by Inspector' : 
                                   e.reason === 'Mafia' ? 'eliminated by Mafia' :
                                   e.reason === 'Protected' ? 'protected by Guardian' : 'voted out';
                    addLog(`${e.name} was ${reason}${e.role ? ` (${e.role})` : ''}`);
                } else {
                    addLog('Guardian saved someone!');
                }
            });
            
            if (data.phase === 'night') {
                addLog('Night falls...');
            } else {
                addLog('Day breaks!');
            }
            
            updateGameScreen();
        }

        function handleGameEnd(data) {
            if (data.players) {
                gameState.players = data.players;
            }
            
            if (data.eliminated) {
                data.eliminated.forEach(e => {
                    if (e.name && e.name !== 'No one') addLog(`${e.name} eliminated`);
                });
            }
            
            addLog(data.message);
            showEndGameScreen(data.winner, data.message);
        }

        function showEndGameScreen(winner, message) {
            document.getElementById('endGameTitle').textContent = winner ? `${winner} Win!` : 'Game Over';
            document.getElementById('endGameMessage').textContent = message || 'Game has ended';
            
            const finalRoles = document.getElementById('finalRoles');
            finalRoles.innerHTML = '<h3 style="margin: 20px 0;">Final Roles:</h3>';
            
            const playerList = gameState.isLocalGame ? gameState.localPlayers : Object.values(gameState.players);
            
            playerList.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${player.name}</span>
                    <span>${player.role} ${player.alive ? '✓' : '✗'}</span>
                `;
                finalRoles.appendChild(div);
            });
            
            showScreen('endGameScreen');
        }

        function playAgain() {
            if (gameState.isLocalGame) {
                gameState.localPlayers.forEach(p => {
                    p.role = null;
                    p.profession = null;
                    p.alive = true;
                });
                gameState.phase = 'lobby';
                gameState.localVotes = {};
                gameState.localNightActions = {};
                gameState.gameStarted = false;
                gameState.localCurrentPlayerIndex = 0;
                
                startLocalGameRoles();
            } else {
                if (!gameState.isHost) {
                    alert('Only host can restart!');
                    return;
                }
                
                Object.values(gameState.players).forEach(p => {
                    p.role = null;
                    p.profession = null;
                    p.alive = true;
                });
                
                gameState.phase = 'lobby';
                gameState.votes = {};
                gameState.hasVoted = false;
                gameState.gameStarted = false;
                gameState.nightActions = {};
                
                broadcast({ type: 'return_to_lobby' });
                handleReturnToLobby();
            }
        }

        function handleReturnToLobby() {
            Object.values(gameState.players).forEach(p => {
                p.role = null;
                p.profession = null;
                p.alive = true;
            });
            
            gameState.phase = 'lobby';
            gameState.votes = {};
            gameState.hasVoted = false;
            gameState.gameStarted = false;
            gameState.nightActions = {};
            
            showScreen('lobbyScreen');
            updatePlayerList();
        }

        function updateVoteProgress(data) {
            const progressEl = document.getElementById('voteProgress');
            if (progressEl) {
                progressEl.textContent = `${data.votes}/${data.needed}`;
            }
        }

        function endGame() {
            if (confirm('End game for everyone?')) {
                broadcast({ type: 'game_end', message: 'Host ended game', winner: null, players: gameState.players });
                handleGameEnd({message: 'Host ended game', winner: null, players: gameState.players});
            }
        }

        function handlePlayerDisconnect(peerId) {
            if (gameState.players[peerId]) {
                const playerName = gameState.players[peerId].name;
                delete gameState.players[peerId];
                delete connections[peerId];
                
                if (gameState.isHost) {
                    broadcast({
                        type: 'player_left',
                        peerId: peerId,
                        playerName: playerName
                    });
                }
                
                updatePlayerList();
                addLog(`${playerName} disconnected`);
            }
        }

        function handlePlayerLeft(data) {
            if (gameState.players[data.peerId]) {
                delete gameState.players[data.peerId];
                updatePlayerList();
                addLog(`${data.playerName} left`);
            }
        }

        // Chat functions
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatData = {
                type: 'chat_message',
                sender: gameState.playerName,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            };
            
            if (gameState.isHost) {
                addChatMessage(chatData);
                broadcast(chatData);
            } else {
                connections[gameState.hostPeerId].send(chatData);
            }
            
            input.value = '';
        }

        function handleChatMessage(data) {
            addChatMessage(data);
            
            if (gameState.isHost && data.sender !== gameState.playerName) {
                broadcast(data);
            }
        }

        function addChatMessage(data) {
            const chatLog = document.getElementById('chatLog');
            if (!chatLog) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;
            chatLog.appendChild(entry);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        // Local Game Functions
        function startLocalGame() {
            gameState.isLocalGame = true;
            gameState.localPlayers = [];
            showScreen('localSetupScreen');
        }

        function addLocalPlayer() {
            const nameInput = document.getElementById('localPlayerName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Enter a name!');
                return;
            }
            
            if (gameState.localPlayers.find(p => p.name === name)) {
                alert('Name already taken!');
                return;
            }
            
            gameState.localPlayers.push({
                name: name,
                role: null,
                profession: null,
                alive: true,
                id: gameState.localPlayers.length
            });
            
            nameInput.value = '';
            updateLocalPlayerList();
        }

        function updateLocalPlayerList() {
            const list = document.getElementById('localPlayerList');
            const count = document.getElementById('localPlayerCount');
            
            list.innerHTML = '';
            count.textContent = gameState.localPlayers.length;
            
            gameState.localPlayers.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${player.name}</span>
                    <button class="btn btn-secondary btn-small" onclick="removeLocalPlayer(${index})">Remove</button>
                `;
                list.appendChild(div);
            });
            
            const configDiv = document.getElementById('localRoleConfig');
            const startBtn = document.getElementById('localStartBtn');
            
            if (gameState.localPlayers.length >= 5) {
                configDiv.style.display = 'block';
                startBtn.disabled = false;
                
                const inspectorCheck = document.getElementById('localEnableInspector');
                const guardianCheck = document.getElementById('localEnableGuardian');
                
                inspectorCheck.disabled = gameState.localPlayers.length < 7;
                guardianCheck.disabled = gameState.localPlayers.length < 13;
                
                if (gameState.localPlayers.length < 7) inspectorCheck.checked = false;
                if (gameState.localPlayers.length < 13) guardianCheck.checked = false;
            } else {
                configDiv.style.display = 'none';
            }
        }

        function removeLocalPlayer(index) {
            gameState.localPlayers.splice(index, 1);
            gameState.localPlayers.forEach((p, i) => p.id = i);
            updateLocalPlayerList();
        }

        function startLocalGameRoles() {
            const playerCount = gameState.localPlayers.length;
            
            let mafiaCount;
            if (playerCount <= 10) mafiaCount = 2;
            else if (playerCount <= 15) mafiaCount = 3;
            else mafiaCount = 4;
            
            const roles = [];
            for (let i = 0; i < mafiaCount; i++) roles.push('Mafia');
            
            const enableInspector = document.getElementById('localEnableInspector').checked;
            const enableGuardian = document.getElementById('localEnableGuardian').checked;
            
            if (enableInspector && playerCount >= 7) roles.push('Inspector');
            if (enableGuardian && playerCount >= 13) roles.push('Guardian');
            
            while (roles.length < playerCount) roles.push('Villager');
            
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }
            
            gameState.localPlayers.forEach((player, i) => {
                player.role = roles[i];
            });
            
            gameState.localCurrentPlayerIndex = 0;
            gameState.gameStarted = true;
            showLocalRoleToPlayer();
        }

        function showLocalRoleToPlayer() {
            const player = gameState.localPlayers[gameState.localCurrentPlayerIndex];
            
            document.getElementById('privacyMessage').textContent = `Pass device to ${player.name}`;
            showScreen('privacyScreen');
        }

        function continueFromPrivacy() {
            const player = gameState.localPlayers[gameState.localCurrentPlayerIndex];
            
            if (player.role && !player.profession) {
                document.getElementById('localCurrentPlayer').textContent = player.name;
                document.getElementById('localRoleName').textContent = player.role.toUpperCase();
                
                const descEl = document.getElementById('localRoleDescription');
                const extraEl = document.getElementById('localRoleExtra');
                
                if (player.role === 'Mafia') {
                    descEl.textContent = 'Eliminate villagers at night. Blend in during the day.';
                    const mafiaMembers = gameState.localPlayers
                        .filter(p => p.role === 'Mafia' && p.id !== player.id)
                        .map(p => p.name);
                    extraEl.textContent = mafiaMembers.length > 0 ? `Partners: ${mafiaMembers.join(', ')}` : 'You are alone';
                } else if (player.role === 'Inspector') {
                    descEl.textContent = 'Each night, choose one player to investigate. If they are Mafia, they are eliminated!';
                    extraEl.textContent = 'Use your power wisely';
                } else if (player.role === 'Guardian') {
                    descEl.textContent = 'Each night, protect one player from Mafia. You cannot speak during discussions.';
                    const mafiaMembers = gameState.localPlayers.filter(p => p.role === 'Mafia').map(p => p.name);
                    extraEl.textContent = `Mafia: ${mafiaMembers.join(', ')}`;
                } else {
                    descEl.textContent = 'Find and eliminate the Mafia through discussion and voting!';
                    extraEl.textContent = 'Trust no one';
                }
                
                showScreen('localRoleScreen');
            } else {
                showLocalVotingForPlayer();
            }
        }

        function acknowledgeLocalRole() {
            document.getElementById('localProfessionPlayer').textContent = 
                gameState.localPlayers[gameState.localCurrentPlayerIndex].name;
            showScreen('localProfessionScreen');
        }

        function submitLocalProfession() {
            const professionInput = document.getElementById('localProfessionInput');
            const profession = professionInput.value.trim();
            
            if (!profession) {
                alert('Enter a profession!');
                return;
            }
            
            gameState.localPlayers[gameState.localCurrentPlayerIndex].profession = profession;
            professionInput.value = '';
            
            gameState.localCurrentPlayerIndex++;
            
            if (gameState.localCurrentPlayerIndex < gameState.localPlayers.length) {
                showLocalRoleToPlayer();
            } else {
                startLocalIntroductions();
            }
        }

        function startLocalIntroductions() {
            document.getElementById('privacyMessage').textContent = 'Introduction Round - Everyone can see';
            showScreen('privacyScreen');
            
            setTimeout(() => {
                const introList = document.getElementById('introList');
                introList.innerHTML = '';
                
                gameState.localPlayers.forEach(player => {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    div.innerHTML = `
                        <span><strong>${player.name}</strong></span>
                        <span>${player.profession}</span>
                    `;
                    introList.appendChild(div);
                });
                
                showScreen('introductionScreen');
            }, 2000);
        }

        function startLocalDayPhase() {
            document.getElementById('localCurrentPhase').textContent = 'Day - Voting';
            document.getElementById('localPhaseInfo').textContent = 'Each player votes to eliminate';
            
            updateLocalGamePlayerList();
            showScreen('localGameScreen');
            
            gameState.localCurrentPlayerIndex = 0;
            showLocalVotingForPlayer();
        }

        function showLocalVotingForPlayer() {
            const player = gameState.localPlayers[gameState.localCurrentPlayerIndex];
            
            if (!player.alive || (gameState.phase === 'day' && player.role === 'Guardian')) {
                gameState.localCurrentPlayerIndex++;
                if (gameState.localCurrentPlayerIndex < gameState.localPlayers.length) {
                    showLocalVotingForPlayer();
                } else {
                    if (gameState.phase === 'night') {
                        processLocalNightActions();
                    } else {
                        processLocalVotes();
                    }
                }
                return;
            }
            
            if (gameState.phase === 'night' && player.role !== 'Mafia' && 
                player.role !== 'Inspector' && player.role !== 'Guardian') {
                gameState.localCurrentPlayerIndex++;
                if (gameState.localCurrentPlayerIndex < gameState.localPlayers.length) {
                    showLocalVotingForPlayer();
                } else {
                    processLocalNightActions();
                }
                return;
            }
            
            document.getElementById('privacyMessage').textContent = `Pass to ${player.name}`;
            showScreen('privacyScreen');
            
            setTimeout(() => {
                document.getElementById('localVotingPlayer').textContent = player.name;
                document.getElementById('localVoteTitle').textContent = 
                    gameState.phase === 'night' ? 
                        (player.role === 'Mafia' ? 'Choose Target' : 
                         player.role === 'Inspector' ? 'Investigate Player' : 'Protect Player') 
                        : 'Vote to Eliminate';
                
                const grid = document.getElementById('localVotingGrid');
                grid.innerHTML = '';
                
                gameState.localPlayers
                    .filter(p => p.alive && p.id !== player.id)
                    .forEach(p => {
                        const btn = document.createElement('button');
                        btn.className = 'vote-btn';
                        btn.textContent = p.name;
                        btn.onclick = () => selectLocalVote(p.id, btn);
                        grid.appendChild(btn);
                    });
                
                document.getElementById('localVotingSection').style.display = 'block';
                showScreen('localGameScreen');
            }, 1500);
        }

        let localSelectedVote = null;
        
        function selectLocalVote(playerId, btn) {
            document.querySelectorAll('#localVotingGrid .vote-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            localSelectedVote = playerId;
        }

        function submitLocalVote() {
            if (localSelectedVote === null) {
                alert('Select someone!');
                return;
            }
            
            const voter = gameState.localPlayers[gameState.localCurrentPlayerIndex];
            
            if (gameState.phase === 'night') {
                gameState.localNightActions[voter.id] = {
                    target: localSelectedVote,
                    action: voter.role
                };
            } else {
                gameState.localVotes[voter.id] = localSelectedVote;
            }
            
            localSelectedVote = null;
            document.getElementById('localVotingSection').style.display = 'none';
            
            gameState.localCurrentPlayerIndex++;
            
            if (gameState.localCurrentPlayerIndex < gameState.localPlayers.length) {
                showLocalVotingForPlayer();
            } else {
                if (gameState.phase === 'night') {
                    processLocalNightActions();
                } else {
                    processLocalVotes();
                }
            }
        }

        function processLocalVotes() {
            const voteCounts = {};
            Object.values(gameState.localVotes).forEach(targetId => {
                voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            });
            
            let maxVotes = 0;
            let eliminatedId = null;
            
            Object.entries(voteCounts).forEach(([playerId, count]) => {
                if (count > maxVotes) {
                    maxVotes = count;
                    eliminatedId = parseInt(playerId);
                }
            });
            
            if (eliminatedId !== null) {
                const eliminated = gameState.localPlayers.find(p => p.id === eliminatedId);
                eliminated.alive = false;
                
                addLocalLog(`${eliminated.name} was voted out (${eliminated.role})`);
                
                if (checkLocalGameEnd()) return;
                
                gameState.phase = 'night';
                gameState.localVotes = {};
                gameState.localNightActions = {};
                gameState.localCurrentPlayerIndex = 0;
                
                setTimeout(() => startLocalNightPhase(), 2000);
            }
        }

        function startLocalNightPhase() {
            document.getElementById('localCurrentPhase').textContent = 'Night';
            document.getElementById('localPhaseInfo').textContent = 'Special roles take action';
            
            updateLocalGamePlayerList();
            addLocalLog('Night falls...');
            
            gameState.localCurrentPlayerIndex = 0;
            showLocalVotingForPlayer();
        }

        function processLocalNightActions() {
            const mafiaActions = Object.values(gameState.localNightActions).filter(a => a.action === 'Mafia');
            const mafiaVotes = {};
            mafiaActions.forEach(a => {
                mafiaVotes[a.target] = (mafiaVotes[a.target] || 0) + 1;
            });
            
            let mafiaTarget = null;
            let maxVotes = 0;
            Object.entries(mafiaVotes).forEach(([playerId, count]) => {
                if (count > maxVotes) {
                    maxVotes = count;
                    mafiaTarget = parseInt(playerId);
                }
            });
            
            const inspectorAction = Object.values(gameState.localNightActions).find(a => a.action === 'Inspector');
            let inspectorResult = null;
            if (inspectorAction) {
                const target = gameState.localPlayers.find(p => p.id === inspectorAction.target);
                if (target && target.role === 'Mafia') {
                    inspectorResult = inspectorAction.target;
                }
            }
            
            const guardianAction = Object.values(gameState.localNightActions).find(a => a.action === 'Guardian');
            const protected = guardianAction ? guardianAction.target : null;
            
            if (inspectorResult !== null) {
                const caught = gameState.localPlayers.find(p => p.id === inspectorResult);
                caught.alive = false;
                addLocalLog(`${caught.name} caught by Inspector (Mafia)`);
            }
            
            if (mafiaTarget !== null && mafiaTarget !== protected) {
                const killed = gameState.localPlayers.find(p => p.id === mafiaTarget);
                killed.alive = false;
                addLocalLog(`${killed.name} eliminated by Mafia (${killed.role})`);
            } else if (mafiaTarget === protected) {
                addLocalLog('Guardian saved someone!');
            }
            
            if (checkLocalGameEnd()) return;
            
            gameState.phase = 'day';
            gameState.localVotes = {};
            gameState.localNightActions = {};
            gameState.localCurrentPlayerIndex = 0;
            
            setTimeout(() => startLocalDayPhase(), 2000);
        }

        function checkLocalGameEnd() {
            const aliveMafia = gameState.localPlayers.filter(p => p.alive && p.role === 'Mafia').length;
            const aliveVillagers = gameState.localPlayers.filter(p => p.alive && p.role !== 'Mafia').length;
            
            if (aliveMafia === 0) {
                showEndGameScreen('Villagers', 'Villagers Win!');
                return true;
            } else if (aliveMafia >= aliveVillagers) {
                showEndGameScreen('Mafia', 'Mafia Wins!');
                return true;
            }
            
            return false;
        }

        function updateLocalGamePlayerList() {
            const list = document.getElementById('localGamePlayerList');
            list.innerHTML = '';
            
            gameState.localPlayers.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${player.name} (${player.profession})</span>
                    <span class="status-badge ${player.alive ? 'badge-alive' : 'badge-dead'}">
                        ${player.alive ? 'ALIVE' : 'DEAD'}
                    </span>
                `;
                list.appendChild(div);
            });
        }

        function addLocalLog(message) {
            const log = document.getElementById('localGameLog');
            if (!log) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Utility functions
        function broadcast(message, excludePeerId = null) {
            Object.entries(connections).forEach(([peerId, conn]) => {
                if (peerId !== excludePeerId) {
                    try {
                        conn.send(message);
                    } catch (e) {
                        console.error('Send failed:', e);
                    }
                }
            });
        }

        function addLog(message) {
            const log = document.getElementById('gameLog');
            if (!log) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initPeer();
        });
    </script>
</body>
</html>